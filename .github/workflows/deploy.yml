name: Deploy EventPass Frontend

on:
  push:
    branches:
      - main
      - uat

jobs:
  deploy-prod:
    if: github.ref == 'refs/heads/main'
    runs-on: [self-hosted, frontend, production]
    environment: Production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare production frontend directory
        run: |
          sudo mkdir -p /var/www/eventpass/frontend
          sudo chown -R ubuntu:ubuntu /var/www/eventpass
          cd /var/www/eventpass/frontend
          rm -rf * .[^.]* || true
          cp -r $GITHUB_WORKSPACE/* .

      - name: Create production .env.local
        run: |
          cd /var/www/eventpass/frontend
          rm -f .env.local
          tee .env.local > /dev/null <<EOF
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_WEBSOCKET_HOST=${{ secrets.NEXT_PUBLIC_WEBSOCKET_HOST }}
          NEXT_PUBLIC_NODE_ENV=${{ secrets.NEXT_PUBLIC_NODE_ENV }}

          NEXT_PUBLIC_AWS_REGION=${{ secrets.NEXT_PUBLIC_AWS_REGION }}
          NEXT_PUBLIC_AWS_ACCESS_KEY_ID=${{ secrets.NEXT_PUBLIC_AWS_ACCESS_KEY_ID }}
          NEXT_PUBLIC_AWS_SECRET_ACCESS_KEY=${{ secrets.NEXT_PUBLIC_AWS_SECRET_ACCESS_KEY }}
          NEXT_PUBLIC_S3_BUCKET=${{ secrets.NEXT_PUBLIC_S3_BUCKET }}
          NEXT_PUBLIC_CLOUDFRONT_URL=${{ secrets.NEXT_PUBLIC_CLOUDFRONT_URL }}
          EOF

      - name: Install, build & restart frontend (prod)
        run: |
          cd /var/www/eventpass/frontend
          npm install
          npm run build
          pm2 restart eventpass-frontend --update-env || pm2 start npm --name "eventpass-frontend" -- run start
          pm2 save


  deploy-uat:
    if: github.ref == 'refs/heads/uat'
    runs-on: [self-hosted, frontend, uat]
    environment: UAT

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare UAT frontend directory
        run: |
          sudo mkdir -p /var/www/eventpass-uat/frontend
          sudo chown -R ubuntu:ubuntu /var/www/eventpass-uat
          cd /var/www/eventpass-uat/frontend
          rm -rf * .[^.]* || true
          cp -r $GITHUB_WORKSPACE/* .

      - name: Create UAT .env.local
        run: |
          cd /var/www/eventpass-uat/frontend
          rm -f .env.local
          tee .env.local > /dev/null <<EOF
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_WEBSOCKET_HOST=${{ secrets.NEXT_PUBLIC_WEBSOCKET_HOST }}
          NEXT_PUBLIC_NODE_ENV=${{ secrets.NEXT_PUBLIC_NODE_ENV }}

          NEXT_PUBLIC_AWS_REGION=${{ secrets.NEXT_PUBLIC_AWS_REGION }}
          NEXT_PUBLIC_AWS_ACCESS_KEY_ID=${{ secrets.NEXT_PUBLIC_AWS_ACCESS_KEY_ID }}
          NEXT_PUBLIC_AWS_SECRET_ACCESS_KEY=${{ secrets.NEXT_PUBLIC_AWS_SECRET_ACCESS_KEY }}
          NEXT_PUBLIC_S3_BUCKET=${{ secrets.NEXT_PUBLIC_S3_BUCKET }}
          NEXT_PUBLIC_CLOUDFRONT_URL=${{ secrets.NEXT_PUBLIC_CLOUDFRONT_URL }}
          EOF

      - name: Install, build & restart frontend (uat)
        run: |
          cd /var/www/eventpass-uat/frontend
          npm install
          npm run build
          pm2 restart eventpass-frontend-uat --update-env || pm2 start npm --name "eventpass-frontend-uat" -- run start
          pm2 save
